sap.ui.define(["sap/ui/core/mvc/Controller","reprequeriments/utils/getData","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/Token","sap/m/MessageToast","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/model/json/JSONModel","sap/ui/core/UIComponent","reprequeriments/utils/constants","sap/ui/export/Spreadsheet","sap/ui/export/library","reprequeriments/model/formatter"],(e,t,r,a,i,n,o,l,s,p,u,g,h,A)=>{"use strict";const S=[{DialogRout:"reprequeriments.view.fragments.mProyecto",DialogID:"V1",InputField:"pspnr",Filter1:"PSPNR"},{DialogRout:"reprequeriments.view.fragments.mReq",DialogID:"V2",InputField:"Req",Filter1:"BANFN"},{DialogRout:"reprequeriments.view.fragments.mMat",DialogID:"V3",InputField:"Matnr",Filter1:"MATNR"},{DialogRout:"reprequeriments.view.fragments.mCat",DialogID:"V4",InputField:"CATEGORY_ID",Filter1:"CATEGORY_ID"},{DialogRout:"reprequeriments.view.fragments.mFam",DialogID:"V5",InputField:"Family",Filter1:"FAMILY_ID"},{DialogRout:"reprequeriments.view.fragments.mFFE",DialogID:"V6",InputField:"FGMDI",Filter1:"FGMDI"},{DialogRout:"reprequeriments.view.fragments.mDiv",DialogID:"V7",InputField:"DIVSN",Filter1:"DIVSN"},{DialogRout:"reprequeriments.view.fragments.mArea",DialogID:"V8",InputField:"AREA",Filter1:"AREA"},{DialogRout:"reprequeriments.view.fragments.mUbi",DialogID:"V9",InputField:"UBI",Filter1:"UBICA"},{DialogRout:"reprequeriments.view.fragments.mSubi",DialogID:"V10",InputField:"SUBI",Filter1:"SUBIC"},{DialogRout:"reprequeriments.view.fragments.mUser",DialogID:"V11",InputField:"CNAME",Filter1:"ERNAM"}];const D=h.EdmType;let E;let I=[],T=[],c=[],d=[],f=[],m=[],M=[],N=[],y=[],R=[],_=[];return e.extend("reprequeriments.controller.Main",{formatter:A,onInit:async function(){E=this.getOwnerComponent().getModel("i18n").getResourceBundle();this._setCurrentMonthRange();this._getData()},_getData:async function(){const e=this.createUrl();const r=await t.getRequeriments(e);const a=this._addSubtotalsAndTotalFlat(r);const{uPro:i,uReq:n,uMat:o,uCat:l,uFam:s,uFfg:p,uDiv:u,uArea:g,uUbi:h,uSub:A,uCrea:S}=r.reduce((e,t)=>{if(!e.tPro[t.PSPNR]){e.tPro[t.PSPNR]=true;e.uPro.push(t)}if(!e.tReq[t.BANFN]){e.tReq[t.BANFN]=true;e.uReq.push(t)}if(!e.tMat[t.MATNR]){e.tMat[t.MATNR]=true;e.uMat.push(t)}if(!e.tCat[t.CATEGORY_ID]){e.tCat[t.CATEGORY_ID]=true;e.uCat.push(t)}if(!e.tFam[t.FAMILY_ID]){e.tFam[t.FAMILY_ID]=true;e.uFam.push(t)}if(!e.tFfg[t.FGMDI]){e.tFfg[t.FGMDI]=true;e.uFfg.push(t)}if(!e.tDiv[t.DIVSN]){e.tDiv[t.DIVSN]=true;e.uDiv.push(t)}if(!e.tArea[t.AREA]){e.tArea[t.AREA]=true;e.uArea.push(t)}if(!e.tUbi[t.UBICA]){e.tUbi[t.UBICA]=true;e.uUbi.push(t)}if(!e.tSub[t.SUBIC]){e.tSub[t.SUBIC]=true;e.uSub.push(t)}if(!e.tCrea[t.CREATION_NAME]){e.tCrea[t.CREATION_NAME]=true;e.uCrea.push(t)}return e},{uPro:[],uReq:[],uMat:[],uCat:[],uFam:[],uFfg:[],uDiv:[],uArea:[],uUbi:[],uSub:[],uCrea:[],tPro:{},tReq:{},tMat:{},tCat:{},tFam:{},tFfg:{},tDiv:{},tArea:{},tUbi:{},tSub:{},tCrea:{}});const D=g.reduce((e,t)=>{if(t.AREA_DESC!==null){e.push({...t,AREA:String(t.AREA)})}return e},[]);const E=this.getOwnerComponent().getModel("serviceModel");E.setProperty("/fPro",i);E.setProperty("/fReq",n);E.setProperty("/fMat",o);E.setProperty("/fCat",l);E.setProperty("/fFam",s);E.setProperty("/ffg",p);E.setProperty("/fDiv",u);E.setProperty("/fArea",D);E.setProperty("/fUbi",h);E.setProperty("/fSub",A);E.setProperty("/fCrea",S);this.getOwnerComponent().getModel("serviceModel").setProperty("/repRequerimientos",a)},createUrl:function(){const e=`${t.getURL()}${u.API.REQUERIMENTS_ENDPOINT}`;let r=this.getView().byId("dateRangeFilter").getDateValue();let a=this.getView().byId("dateRangeFilter").getSecondDateValue();let i=this.formatDate(r);let n=this.formatDate(a);const o=i&&n?`(EBAN.ERDAT BETWEEN DATE '${i}' AND DATE '${n}')`:"";const l=[{id:"pspnr",param:"PSPNR"},{id:"Req",param:"BANFN"},{id:"Matnr",param:"EBAN.MATNR"},{id:"CATEGORY_ID",param:"MARA.CATEGORY"},{id:"Family",param:"MARA.FAMILY"},{id:"FGMDI",param:"EBAN.FGMDI"},{id:"DIVSN",param:"EBAN.DIVSN"},{id:"AREA",param:"EBAN.AREA"},{id:"UBI",param:"EBAN.UBICA"},{id:"SUBI",param:"EBAN.SUBIC"},{id:"CNAME",param:"EBAN.ERNAM"}];let s=l.map(e=>{const t=this.byId(e.id).getTokens().map(e=>e.getKey());if(t.length===0)return null;const r=t.map(t=>`${e.param} EQ '${t}'`).join(" OR ");return`(${r})`}).filter(Boolean);let p=[];if(o)p.push(o);if(s.length>0)p.push(s.join(" AND "));const g=p.length>0?`$filter=${p.join(" AND ")}`:"";return g?`${e}?${g}`:e},formatDate:function(e){if(!e)return"";let t=e.getFullYear();let r=String(e.getMonth()+1).padStart(2,"0");let a=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${a}`},_setCurrentMonthRange:function(){var e=this.byId("dateRangeFilter");var t=new Date;t.setDate(1);var r=new Date(t);r.setMonth(r.getMonth()+1);r.setDate(0);var a=this._formatDate(t);var i=this._formatDate(r);e.setDateValue(new Date(a));e.setSecondDateValue(new Date(i))},_formatDate:function(e){var t=e.getFullYear();var r=(e.getMonth()+1).toString().padStart(2,"0");var a=e.getDate().toString().padStart(2,"0");return t+"-"+r+"-"+a},onDateRangeChange:function(e){var t=e.getSource();var r=t.getDates();if(r.length===2){var a=r[0];var i=r[1]}},findHandleFragment:async function(e){const t=e.getSource();const r=t.data("fragmentPath");const a=S.find(e=>e.DialogID===r);if(a){this.openValueHelpDialog(a.DialogRout,a.Filter1,a.DialogID)}},openValueHelpDialog:function(e,t,n){if(!this._dialogs)this._dialogs={};if(!this._dialogs[e]){this._dialogs[e]=i.load({id:n,name:e,controller:this}).then(e=>{this.getView().addDependent(e);return e})}this._dialogs[e].then(e=>{e.getBinding("items").filter([new r(t,a.Contains,"")]);e.open()})},_handleDialogClose:function(e){const t=e.getParameter("selectedItems")||[];const r=e.getSource().data("fragmentPath");const a=this.byId(r);let i=this.byId(r);a.removeAllTokens();var o=S.find(function(e){return e.InputField===r});if(t&&t.length>0){t.forEach(function(e){switch(o.InputField){case"pspnr":I=[];I.push(e.getTitle());break;case"Req":T=[];T.push(e.getTitle());break;case"Matnr":c=[];c.push(e.getTitle());break;case"CATEGORY_ID":d=[];d.push(e.getTitle());break;case"Family":f=[];f.push(e.getTitle());break;case"FGMDI":m=[];m.push(e.getTitle());break;case"DIVSN":M=[];M.push(e.getTitle());break;case"AREA":N=[];N.push(e.getTitle());break;case"UBI":y=[];y.push(e.getTitle());break;case"SUBI":R=[];R.push(e.getTitle());break;case"CNAME":_=[];_.push(e.getTitle());break;default:break}a.addToken(new n({text:e.getDescription(),key:e.getTitle()}))})}},onOpenColumnSettings:function(){this.byId("columnSettingsDialog").open()},onCloseColumnSettings:function(){this.byId("columnSettingsDialog").close()},onToggleColumnVisibility:function(e){let t=e.getSource().getTitle();let r=this.getView().getModel("settingsModel");let a=r.getProperty("/"+t);r.setProperty("/"+t,!a)},onExport:function(){if(!this._oTable){this._oTable=this.byId("tReqs")}const e=this._oTable;const t=e.getBinding("rows");let r=t.getCurrentContexts().map(function(e){return e.getObject()});const a=this.createColumnConfig();const i={workbook:{columns:a,hierarchyLevel:"Level"},dataSource:t,fileName:"Requerimientos Export.xlsx",worker:false};const n=new g(i);n.build().finally(function(){n.destroy()})},createColumnConfig:function(){const e=[];e.push({property:"LOEKZ",type:D.String,label:E.getText("LOEKZ")});e.push({property:"PSPNR",type:D.String,label:E.getText("PSPNR")});e.push({property:"PROJECT_NAME",type:D.String,label:E.getText("PROJECT_NAME")});e.push({property:"ERDAT",type:D.String,label:E.getText("ERDAT")});e.push({property:"BANFN",type:D.String,label:E.getText("BANFN")});e.push({property:"BNFPO",type:D.String,label:E.getText("BNFPO")});e.push({property:"STATUS",type:D.String,label:E.getText("STATUS")});e.push({property:"MATNR",type:D.String,label:E.getText("MATNR")});e.push({property:"MATERIAL_NAME",type:D.String,label:E.getText("MATERIAL_NAME")});e.push({property:"MATERIAL_DESC",type:D.String,label:E.getText("MATERIAL_DESC")});e.push({property:"MENGE",type:D.String,label:E.getText("MENGE")});e.push({property:"MEINS",type:D.String,label:E.getText("MEINS")});e.push({property:"CATEGORY_DESC",type:D.String,label:E.getText("CATEGORY_DESC")});e.push({property:"FAMILY_DESC",type:D.String,label:E.getText("FAMILY_DESC")});e.push({property:"BRAND_DESC",type:D.String,label:E.getText("BRAND_DESC")});e.push({property:"MODEL_DESC",type:D.String,label:E.getText("MODEL_DESC")});e.push({property:"MAT_DIMENSIONS",type:D.String,label:E.getText("MAT_DIMENSIONS")});e.push({property:"MAT_FIXED_ASSET",type:D.String,label:E.getText("MAT_FIXED_ASSET")});e.push({property:"MAT_STANDARD",type:D.String,label:E.getText("MAT_STANDARD")});e.push({property:"MAT_PATRIMONIO",type:D.String,label:E.getText("MAT_PATRIMONIO")});e.push({property:"MAT_SPECIAL",type:D.String,label:E.getText("MAT_SPECIAL")});e.push({property:"DIVISION_DESC",type:D.String,label:E.getText("DIVISION_DESC")});e.push({property:"AREA_DESC",type:D.String,label:E.getText("AREA_DESC")});e.push({property:"UBICA",type:D.String,label:E.getText("UBICA")});e.push({property:"SUBIC",type:D.String,label:E.getText("SUBIC")});e.push({property:"SUMIN",type:D.String,label:E.getText("SUMIN")});e.push({property:"VISTA",type:D.String,label:E.getText("VISTA")});e.push({property:"EBELN",type:D.String,label:E.getText("EBELN")});e.push({property:"EBELP",type:D.String,label:E.getText("EBELP")});e.push({property:"TEXTO",type:D.String,label:E.getText("TEXTO")});e.push({property:"CREATION_NAME",type:D.String,label:E.getText("CREATION_NAME")});e.push({property:"MODIFY_NAME",type:D.String,label:E.getText("MODIFY_NAME")});return e},_addSubtotalsAndTotalFlat:function(e){const t=[];let r=null;let a=0;let i=0;let n=0;for(let o=0;o<e.length;o++){const l=e[o];if(r&&l.BANFN!==r){t.push({isSubtotal:true,MATERIAL_DESC:E.getText("sub"),MENGE:a});a=0;i=0}t.push(l);a+=parseFloat(l.MENGE);n+=parseFloat(l.MENGE);r=l.BANFN}t.push({isSubtotal:true,MATERIAL_DESC:E.getText("sub"),MENGE:a});t.push({isTotal:true,MATERIAL_DESC:E.getText("tot"),MENGE:n});return t},_handleSearch:function(e,t){var i=e.getParameter("value");var n="";if(i){n=new r([new r(t,a.Contains,i)])}e.getSource().getBinding("items").filter([n])},_handleProyecto:function(e){this._handleSearch(e,"PROJECT_NAME")},_handleReq:function(e){this._handleSearch(e,"BANFN")},_handleMat:function(e){this._handleSearch(e,"MATERIAL_NAME")},_handleCat:function(e){this._handleSearch(e,"CATEGORY_DESC")},_handleFam:function(e){this._handleSearch(e,"FAMILY_DESC")},_handleFFE:function(e){this._handleSearch(e,"FGMDI")},_handleDiv:function(e){this._handleSearch(e,"DIVISION_DESC")},_handleArea:function(e){this._handleSearch(e,"AREA_DESC")},_handleUbi:function(e){this._handleSearch(e,"UBICA")},_handleSubi:function(e){this._handleSearch(e,"SUBIC")},_handleUser:function(e){this._handleSearch(e,"CREATION_NAME")}})});
//# sourceMappingURL=Main.controller.js.map